from fastapi import FastAPI, UploadFile, File, Form
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import docx
import PyPDF2
import io
import re
from typing import List

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

def extract_text_from_pdf(file_bytes: bytes) -> str:
    reader = PyPDF2.PdfReader(io.BytesIO(file_bytes))
    text = ""
    for page in reader.pages:
        text += page.extract_text() + "\n"
    return text

def extract_text_from_docx(file_bytes: bytes) -> str:
    document = docx.Document(io.BytesIO(file_bytes))
    return "\n".join([para.text for para in document.paragraphs])

def clean_text(text: str) -> str:
    text = text.lower()
    text = re.sub(r"\s+", " ", text)
    return text.strip()

def extract_skills(text: str) -> List[str]:
    common_skills = [
        "python","java","javascript","sql","html","css","react","node",
        "aws","azure","docker","kubernetes","machine learning","nlp",
        "communication","leadership","project management"
    ]
    return [skill for skill in common_skills if skill in text]

def extract_years_of_experience(text: str) -> int:
    match = re.search(r"(\d+)\+?\s+years", text)
    return int(match.group(1)) if match else 0

def extract_education(text: str) -> List[str]:
    degrees = ["bachelor", "master", "phd", "mba"]
    return [d for d in degrees if d in text]

class ATSResponse(BaseModel):
    score: float
    matched_skills: List[str]
    missing_skills: List[str]
    experience_match: bool
    education_match: bool

@app.post("/ats-score", response_model=ATSResponse)
async def ats_score(
    cv_file: UploadFile = File(...),
    job_description: str = Form(...)
):
    cv_bytes = await cv_file.read()

    if cv_file.filename.endswith(".pdf"):
        cv_text = extract_text_from_pdf(cv_bytes)
    elif cv_file.filename.endswith(".docx"):
        cv_text = extract_text_from_docx(cv_bytes)
    else:
        return {"error": "Unsupported file format"}

    cv_text = clean_text(cv_text)
    jd_text = clean_text(job_description)

    cv_skills = extract_skills(cv_text)
    jd_skills = extract_skills(jd_text)

    matched = list(set(cv_skills).intersection(jd_skills))
    missing = list(set(jd_skills) - set(cv_skills))

    cv_exp = extract_years_of_experience(cv_text)
    jd_exp = extract_years_of_experience(jd_text)
    exp_match = cv_exp >= jd_exp

    cv_edu = extract_education(cv_text)
    jd_edu = extract_education(jd_text)
    edu_match = bool(set(jd_edu).intersection(cv_edu))

    skill_score = len(matched) / len(jd_skills) if jd_skills else 1
    exp_score = 1 if exp_match else 0
    edu_score = 1 if edu_match else 0

    final_score = (
        skill_score * 0.60 +
        exp_score * 0.25 +
        edu_score * 0.15
    ) * 100

    return ATSResponse(
        score=round(final_score, 2),
        matched_skills=matched,
        missing_skills=missing,
        experience_match=exp_match,
        education_match=edu_match
    )
